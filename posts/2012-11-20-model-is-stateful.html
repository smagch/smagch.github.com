<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="description" content="about smagch"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="author" content="smagch"><meta name="keywords" content="Node.js,javascript"><script src="/javascripts/modernizr.min.js"></script><link rel="stylesheet" href="/stylesheets/post.css"></head><body><header id="header" class="clearfix"><div class="container"><a href="/"><img src="http://www.gravatar.com/avatar/75404230bb6991027394855068b0e487.png"><h1>smagch.github.io</h1></a><aside><a href="/about.html">about me</a></aside></div></header><div id="content"><article class="container"><header class="inner"><h1>Model is stateful</h1></header><div class="inner"><p>I&#39;ve been doing <a href="http://backbonejs.org/">Backbone.js</a> project for quite a while.
So I&#39;m going to share some tips I&#39;ve learned.
Example application is <a href="https://github.com/smagch/backbone-examples">placed on github</a>.
This post is the first part of my Backbone tips series.
So I&#39;ll add more examples in the future.</p>
<ul>
<li>updates Nov. 22 2012: remove a description about verbose JSON.</li>
</ul>
<h2><a href="#update-view-via-custom-event">Update View via custom event</a></h2>
<p>Let&#39;s take a following example.</p>
<ul>
<li>There are 20 recent HN comments.</li>
<li>User can highlight one comment by clicking a comment.</li>
<li>Highlight will be removed when User click background.</li>
</ul>
<div class='img-container'>
  <a href='http://smagch.github.com/backbone-examples/select/'>
    <img src='/images/hn-comments.png'></img>
  </a>
</div>

<p>One way of implementation might be something like this.</p>
<pre><code class="lang-javascript"><span class="kd">var</span> <span class="nx">ItemView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click li&#39;</span><span class="o">:</span> <span class="s1">&#39;clicked&#39;</span>
  <span class="p">},</span>
  <span class="nx">clicked</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
    <span class="nx">$target</span>
      <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">);</span>
      <span class="p">.</span><span class="nx">siblings</span><span class="p">(</span><span class="s1">&#39;.selected&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">({</span> <span class="nx">models</span><span class="o">:</span> <span class="nx">json</span> <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<p>What I want to point out in this post is that it&#39;s better to write like following.</p>
<pre><code class="lang-javascript"><span class="kd">var</span> <span class="nx">ItemView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;deselect&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">deselect</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click li&#39;</span><span class="o">:</span> <span class="s1">&#39;clicked&#39;</span>
  <span class="p">},</span>
  <span class="nx">clicked</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[data-id=&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">$target</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">deselect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">$target</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">({</span> <span class="nx">models</span><span class="o">:</span> <span class="nx">json</span> <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<p>The Latter <code>ItemView</code> update its DOM element via <code>&quot;select&quot;</code> and <code>&quot;deselect&quot;</code> events rather than via <code>&quot;click&quot;</code> DOM event.
It just call collection&#39;s <code>.select()</code> method when it catch <code>&quot;click&quot;</code> event. The former example have less codes.
But the latter approach is simple in the sense that application&#39;s event flow is well-organized.</p>
<p>In a nutshell, View is just to represent Model.
So it&#39;s important to take this principle: <em>Change Model rather than View</em>.
Even if there are no changes in persistent attributes in Model.</p>
<p>Let&#39;s get into detail implementation of Model and Collection.</p>
<pre><code class="lang-javascript"><span class="kd">var</span> <span class="nx">ItemModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">toVerboseJSON</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
    <span class="nx">json</span><span class="p">.</span><span class="nx">cid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cid</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">ItemCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">ItemModel</span><span class="p">,</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_selected</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">params</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">limit</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s1">&#39;filter[fields][type]&#39;</span><span class="o">:</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sortby&#39;</span><span class="o">:</span> <span class="s1">&#39;create_ts desc&#39;</span>
  <span class="p">},</span>
  <span class="nx">url</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;http://api.thriftdb.com/api.hnsearch.com/items/_search?&#39;</span>
      <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&amp;callback=?&#39;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">results</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">toVerboseJSON</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toVerboseJSON</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">model</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;invlid id : &#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>

    <span class="c1">// balk if the modal is already selected</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_selected</span> <span class="o">===</span> <span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// selected model should be single</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_selected</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">deselect</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_selected</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">deselect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_selected</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;deselect&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_selected</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_selected</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<p>In this example, I use <code>data-id</code> attribute.
The template for item is following.</p>
<pre><code>&lt;% _.each(models, function (model) { %&gt;
  &lt;li data-id=&quot;&lt;%= model.id %&gt;&quot;&gt;
    &lt;p class=&#39;user&#39;&gt;&lt;%= model.username %&gt;&lt;/p&gt;
    &lt;%= model.text %&gt;
  &lt;/li&gt;
&lt;% }); %&gt;</code></pre>
<p>The comment item will be deselected with clicking background.
<code>ItemView</code> stop <code>&quot;click&quot;</code> event propagation with <code>e.stopPropagation();</code> in <code>&quot;click&quot;</code> event handler.
So it&#39;s safe to do like this.</p>
<pre><code class="lang-javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">itemCollection</span><span class="p">.</span><span class="nx">deselect</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
<h2><a href="#design-event-flow">Design event flow</a></h2>
<p>Let&#39;s add one more View to make app more neat.
<code>JsonView</code> will show user raw JSON data on the right side when a comment is selected.</p>
<div class='img-container'>
  <a href='http://smagch.github.com/backbone-examples/select2/'>
    <img src='/images/hn-comments-json.png'></img>
  </a>
</div>

<pre><code class="lang-javascript"><span class="kd">var</span> <span class="nx">JsonView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;deselect&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">deselect</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;pre&gt;&lt;code&gt;&#39;</span> <span class="o">+</span> <span class="nx">json</span> <span class="o">+</span> <span class="s1">&#39;&lt;/code&gt;&lt;/pre&gt;&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">deselect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<p>Let&#39;s sort out the architecture of event flow.</p>
<h3>ItemCollection</h3>
<ul>
<li><code>.select()</code> - trigger <code>&quot;select&quot;</code> event and pass selected <code>ItemModel</code></li>
<li><code>.deselect()</code> - trigger <code>&quot;deselect&quot;</code> event and pass <code>ItemModel</code> to deselect</li>
</ul>
<h3>ItemView</h3>
<ul>
<li><code>&quot;click&quot;</code> event on item =&gt; select</li>
<li><code>&quot;select&quot;</code> event =&gt; highlight item</li>
<li><code>&quot;deselect&quot;</code> event =&gt; remove highlight item</li>
</ul>
<h3>JsonView</h3>
<ul>
<li><code>&quot;select&quot;</code> event =&gt; render JSON</li>
<li><code>&quot;deselect&quot;</code> event =&gt; clean rendered JSON</li>
</ul>
<h3>body</h3>
<ul>
<li><code>&quot;click&quot;</code> event =&gt; deselect</li>
</ul>
<p><code>ItemView</code> will need to have a reference of <code>JsonView</code> without <code>&quot;select&quot;</code> event.
Let&#39;s take a look at one possible implementation without <code>&quot;select&quot;</code> event.</p>
<h3>ItemView without <code>&quot;select&quot;</code> event</h3>
<ul>
<li><code>&quot;click&quot;</code> event =&gt; highlight comment item &amp; show JSON.</li>
</ul>
<pre><code class="lang-javascript"><span class="cm">/**</span>
<span class="cm"> * ItemCollection click handler without &quot;select&quot; event</span>
<span class="cm"> */</span>

<span class="nx">clicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">$target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">$target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

  <span class="c1">// highlight comment item</span>
  <span class="kd">var</span> <span class="nx">$target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
  <span class="nx">$target</span>
    <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">);</span>
    <span class="p">.</span><span class="nx">siblings</span><span class="p">(</span><span class="s1">&#39;.selected&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">);</span>

  <span class="c1">// show JSON</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">jsonView</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>

  <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
<p>Even though <code>ItemView</code> and <code>JsonView</code> are sibling in DOM structure, <code>ItemView</code> need to hold <code>JsonView</code> in this way.</p>
<pre><code>&lt;h1&gt;Recent HN Comments&lt;/h1&gt;
&lt;ul id=&#39;item-view&#39;&gt;&lt;/ul&gt;
&lt;div id=&#39;json-view&#39;&gt;&lt;/div&gt;</code></pre>
<p>In this case <code>JsonView</code> is just a simple module which intended to be used from other module.
Selecting a comment is internally handled in <code>ItemView</code>.</p>
<pre><code class="lang-javascript"><span class="cm">/**</span>
<span class="cm"> * Approach without &quot;select&quot; event</span>
<span class="cm"> * itemView need to have jsonView</span>
<span class="cm"> *</span>
<span class="cm"> * + itemView</span>
<span class="cm"> *   - el</span>
<span class="cm"> *   - collection</span>
<span class="cm"> *   - template</span>
<span class="cm"> *   + jsonView</span>
<span class="cm"> *     - el</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">itemCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ItemCollection</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">jsonView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonView</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="s1">&#39;#json-view&#39;</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">itemView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ItemView</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="s1">&#39;#item-view&#39;</span><span class="p">,</span>
  <span class="nx">collection</span><span class="o">:</span> <span class="nx">itemCollection</span><span class="p">,</span>
  <span class="nx">template</span><span class="o">:</span> <span class="nx">itemTemplate</span><span class="p">,</span>
  <span class="nx">jsonView</span><span class="o">:</span> <span class="nx">jsonView</span>
<span class="p">});</span>
</code></pre>
<p>On the other hand, with <code>&quot;select&quot;</code> event, <code>JsonView</code> and <code>ItemView</code> is peer module. They don&#39;t care about each other.</p>
<pre><code class="lang-javascript"><span class="cm">/**</span>
<span class="cm"> * Approach with &quot;select&quot; event</span>
<span class="cm"> * jsonView and itemView don&#39;t care about each other</span>
<span class="cm"> *</span>
<span class="cm"> * + itemView</span>
<span class="cm"> *   - el</span>
<span class="cm"> *   - collection</span>
<span class="cm"> *   - template</span>
<span class="cm"> *</span>
<span class="cm"> * + jsonView</span>
<span class="cm"> *   - el</span>
<span class="cm"> *   - collection</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">itemCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ItemCollection</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">jsonView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonView</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="s1">&#39;#json-view&#39;</span><span class="p">,</span>
  <span class="nx">collection</span><span class="o">:</span> <span class="nx">itemCollection</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">itemView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ItemView</span><span class="p">({</span>
  <span class="nx">el</span><span class="o">:</span> <span class="s1">&#39;#item-view&#39;</span><span class="p">,</span>
  <span class="nx">collection</span><span class="o">:</span> <span class="nx">itemCollection</span><span class="p">,</span>
  <span class="nx">template</span><span class="o">:</span> <span class="nx">itemTemplate</span>
<span class="p">});</span>
</code></pre>
<p>In application in this scale, the benefit isn&#39;t much clear.
But it should be noted that there is a big difference in structure between them.
With <code>&quot;select&quot;</code> event, <code>JsonView</code> describe its behavior by binding <code>&quot;select&quot;</code> and <code>&quot;deselect&quot;</code> event handler.
So in this case, <code>JsonView</code> is an application specific module.</p>
<h2><a href="#dont-trigger-outside-of-module">Don&#39;t <code>.trigger()</code> outside of module</a></h2>
<p>Once you define <code>&quot;select&quot;</code> event, you may want to <code>collection.trigger(&quot;select&quot;, model);</code>
when you want item to be selected.
This is a certain bad practice when you design your own custom event.</p>
<p>Let&#39;s take a look at <code>ItemCollection.prototype.select</code> method one more time.</p>
<pre><code class="lang-javascript"><span class="nx">select</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">model</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;invlid id : &#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>

  <span class="c1">// balk if the modal is already selected</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_selected</span> <span class="o">===</span> <span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// selected model should be single</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_selected</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">deselect</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_selected</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>It does internally two things.</p>
<ul>
<li>balk if the modal is already selected</li>
<li>call <code>.deselect()</code> internally to keep selected model single.</li>
</ul>
<p>Where do you put this kind of internal flow control when you trigger events spontaneously outside of module?
Once you define custom event, you can get hang of application&#39;s event flow clearly.
But it&#39;s just binding functions when you trigger custom event randomly outside of module.</p>
<p>Let&#39;s take a look at <code>Backbone.Collection.prototype.reset</code> from <a href="http://backbonejs.org/">Backbone.js</a> v0.9.2 source.
<a href="https://github.com/documentcloud/backbone/blob/0.9.2/backbone.js#L738-L748">https://github.com/documentcloud/backbone/blob/0.9.2/backbone.js#L738-L748</a></p>
<pre><code class="lang-javascript"><span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_removeReference</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_reset</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">options</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span> <span class="o">||</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silent</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">},</span>
</code></pre>
<p>It trigger <code>&quot;reset&quot;</code> event via <code>.reset()</code> method after some cleanup logics.
Let&#39;s take this pattern all the time.</p>
<pre><code class="lang-javascript"><span class="nx">custom_event</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// some internal logics</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;custom_event&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<h2><a href="#consider-which-data-user-is-interacting-with-before-starting-to-write-codes">Consider which data user is interacting with before starting to write codes</a></h2>
<p>Even if you&#39;re using <a href="http://backbonejs.org/">Backbone.js</a> and get rid of DOM manipulation spaghetti,
spaghetti can still happen when you don&#39;t design your application carefully.
What Application stand for?
I&#39;d say <em>Application is to let user interact with data.</em>
So it&#39;s important to consider data first.
And then you may design some custom events and their event flow to come up to the spec of application.
In the example, I came up with <code>&quot;select&quot;</code> event to allow user to select and show a model from HN comment item list.</p>
<h2><a href="#next-post">Next post</a></h2>
<p>Next time, I&#39;ll describe more about how to design custom events which do server request.
And how to interact with Router nicely in a larger scale application.
In the future, I want to give a large scale example which has lots of Collection and multiple Router.</p>
</div></article><div class="comments"><div class="container"><div id="disqus_thread"></div></div></div><script type="text/javascript">
     /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
     var disqus_shortname = 'uithingsconsidered'; // required: replace example with your forum shortname

     /* * * DON'T EDIT BELOW THIS LINE * * */
     (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div><script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25646251-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></body></html>